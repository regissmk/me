<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro | Memory School Fotografia</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f7f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 700px;
            box-sizing: border-box;
        }
        h1 {
            text-align: center;
            color: #0F3A7D;
            margin-bottom: 20px;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }
        .step-indicator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #e0e0e0;
            transform: translateY(-50%);
            z-index: 0;
        }
        .step-dot {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #fff;
            z-index: 1;
            position: relative;
            transition: background-color 0.3s ease;
        }
        .step-dot.active {
            background-color: #0F3A7D;
        }
        .step-dot.completed {
            background-color: #36B37E;
        }
        .step-label {
            text-align: center;
            font-size: 0.8em;
            color: #555;
            margin-top: 5px;
        }
        .step-dot.active + .step-label {
            color: #0F3A7D;
            font-weight: bold;
        }
        .step-content {
            display: none; /* Hidden by default */
            margin-top: 20px;
        }
        .step-content.active {
            display: block;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #344563;
        }
        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="date"],
        input[type="tel"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }
        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        button.primary {
            background-color: #0F3A7D;
            color: #fff;
        }
        button.primary:hover {
            background-color: #0A2B5C;
        }
        button.secondary {
            background-color: #e0e0e0;
            color: #333;
        }
        button.secondary:hover {
            background-color: #d0d0d0;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .error-message {
            color: #FF4C8D;
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
        }
        .child-form {
            border: 1px solid #e0e0e0;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            background-color: #fdfdfd;
            position: relative;
        }
        .child-form h3 {
            margin-top: 0;
            color: #0F3A7D;
        }
        .remove-child-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #FF4C8D;
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        .remove-child-btn:hover {
            background-color: #D03A7C;
        }
        .add-child-btn {
            width: 100%;
            margin-top: 10px;
            background-color: #36B37E;
            color: #fff;
        }
        .add-child-btn:hover {
            background-color: #2CA070;
        }
        .summary-item {
            margin-bottom: 10px;
            padding: 8px;
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        .summary-item strong {
            color: #344563;
        }
        .plan-option, .product-option {
            border: 1px solid #e0e0e0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .plan-option.selected, .product-option.selected {
            border-color: #0F3A7D;
            box-shadow: 0 0 0 2px rgba(15, 58, 125, 0.3);
        }
        .plan-option input[type="radio"], .product-option input[type="checkbox"] {
            margin-right: 10px;
        }
        .plan-option label, .product-option label {
            display: inline;
            font-weight: normal;
        }
        .plan-option .price, .product-option .price {
            float: right;
            font-weight: bold;
            color: #0F3A7D;
        }
        .plan-option .description, .product-option .description {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Cadastro Memory School Fotografia</h1>
        <p id="contract-name" style="text-align: center; font-weight: bold; color: #0F3A7D; margin-bottom: 20px;"></p>
        <div class="step-indicator">
            <div class="step-dot" data-step="1">1</div>
            <div class="step-dot" data-step="2">2</div>
            <div class="step-dot" data-step="3">3</div>
            <div class="step-dot" data-step="4">4</div>
            <div class="step-dot" data-step="5">5</div>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
            <div class="step-label">CPF</div>
            <div class="step-label">Dados do Responsável</div>
            <div class="step-label">Dados do(s) Filho(s)</div>
            <div class="step-label">Escolha do Plano</div>
            <div class="step-label">Conclusão</div>
        </div>

        <form id="registrationForm">
            <!-- Step 1: CPF -->
            <div class="step-content" data-step="1">
                <h2>Etapa 1: CPF</h2>
                <div class="form-group">
                    <label for="cpf">CPF</label>
                    <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00" required maxlength="14">
                </div>
            </div>

            <!-- Step 2: Dados do Responsável -->
            <div class="step-content" data-step="2">
                <h2>Etapa 2: Dados do Responsável</h2>
                <div class="form-group">
                    <label for="parentName">Nome Completo</label>
                    <input type="text" id="parentName" name="parentName" placeholder="Seu nome completo" required>
                </div>
                <div class="form-group">
                    <label for="phone">Telefone</label>
                    <input type="tel" id="phone" name="phone" placeholder="(XX) XXXXX-XXXX" required maxlength="15">
                </div>
                <div class="form-group">
                    <label for="parentEmail">Email</label>
                    <input type="email" id="parentEmail" name="parentEmail" placeholder="seu@email.com" required>
                </div>
                <div class="form-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" name="password" placeholder="********" required minlength="6">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Repetir Senha</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" placeholder="********" required minlength="6">
                </div>
            </div>

            <!-- Step 3: Dados do(s) Filho(s) -->
            <div class="step-content" data-step="3">
                <h2>Etapa 3: Dados do(s) Filho(s)</h2>
                <div id="children-forms-container">
                    <!-- Child form template will be cloned here -->
                </div>
                <button type="button" class="add-child-btn primary" id="addChildBtn">Adicionar Outro Filho</button>
            </div>

            <!-- Step 4: Escolha do Plano -->
            <div class="step-content" data-step="4">
                <h2>Etapa 4: Escolha do Plano</h2>
                <p id="plan-selection-message" style="margin-bottom: 15px; color: #666;"></p>
                <div id="plans-container" class="form-group">
                    <!-- Plans will be loaded here -->
                </div>
                <div id="products-container" class="form-group">
                    <!-- Products will be loaded here -->
                </div>
                <p id="no-plans-products-message" style="text-align: center; color: #666; display: none;">Nenhum plano ou produto associado a este contrato.</p>
            </div>

            <!-- Step 5: Conclusão -->
            <div class="step-content" data-step="5">
                <h2>Etapa 5: Conclusão</h2>
                <p style="text-align: center; margin-bottom: 20px;">Por favor, revise suas informações antes de finalizar.</p>
                <div id="summary-container">
                    <!-- Summary will be generated here -->
                </div>
                <p style="text-align: center; margin-top: 20px; font-size: 0.9em; color: #666;">
                    Ao clicar em "Finalizar Cadastro", você concorda com os Termos de Uso.
                </p>
            </div>

            <div class="button-group">
                <button type="button" class="secondary" id="prevBtn" style="display: none;">Anterior</button>
                <button type="button" class="primary" id="nextBtn">Próximo</button>
                <button type="submit" class="primary" id="submitBtn">Finalizar Cadastro</button>
            </div>
            <p class="error-message" id="errorMessage"></p>
        </form>
    </div>

    <!-- Hidden template for child form -->
    <template id="child-form-template">
        <div class="child-form">
            <h3>Filho(a) <span class="child-number"></span></h3>
            <button type="button" class="remove-child-btn" style="display: none;">Remover</button>
            <div class="form-group">
                <label for="childName">Nome Completo do Aluno</label>
                <input type="text" class="child-name" name="childName" placeholder="Nome do aluno" required>
            </div>
            <div class="form-group">
                <label for="school">Escola</label>
                <input type="text" class="child-school" name="school" readonly style="background-color: #f0f0f0; cursor: not-allowed;">
            </div>
            <div class="form-group">
                <label for="class">Turma</label>
                <input type="text" class="child-class" name="class" placeholder="Ex: 3º Ano A">
            </div>
            <div class="form-group">
                <label for="shift">Turno</label>
                <input type="text" class="child-shift" name="shift" placeholder="Manhã/Tarde/Noite">
            </div>
            <div class="form-group">
                <label for="dob">Data de Nascimento</label>
                <input type="text" class="child-dob" name="dob" placeholder="DD/MM/YYYY" required maxlength="10">
                <p class="child-age-display" style="font-size: 0.8em; color: #666; margin-top: 5px;"></p>
            </div>
            <div class="form-group">
                <label for="photo">Foto do Filho (para reconhecimento facial)</label>
                <input type="file" class="child-photo" name="photo" accept="image/*">
                <div class="photo-preview-container" style="margin-top: 10px; display: none;">
                    <img class="photo-preview" src="" alt="Preview" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;">
                    <span class="photo-filename" style="font-size: 0.9em; color: #666; margin-left: 10px;"></span>
                </div>
            </div>
        </div>
    </template>

    <script>
        const steps = document.querySelectorAll('.step-content');
        const stepDots = document.querySelectorAll('.step-dot');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');
        const addChildBtn = document.getElementById('addChildBtn');
        const childrenFormsContainer = document.getElementById('children-forms-container');
        const childFormTemplate = document.getElementById('child-form-template');
        const errorMessage = document.getElementById('errorMessage');
        const summaryContainer = document.getElementById('summary-container');
        const contractNameDisplay = document.getElementById('contract-name');
        const plansContainer = document.getElementById('plans-container');
        const productsContainer = document.getElementById('products-container');
        const planSelectionMessage = document.getElementById('plan-selection-message');
        const noPlansProductsMessage = document.getElementById('no-plans-products-message');

        let currentStep = 1;
        let contractToken = "{{ token }}"; // Flask will inject the token here
        let contractData = {
            id: null,
            name: '',
            plans: [],
            products: []
        };
        let formData = {
            cpf: '',
            parentName: '',
            phone: '',
            parentEmail: '',
            password: '',
            confirmPassword: '',
            children: [],
            selectedPlan: null,
            selectedProducts: []
        };

        // --- Utility Functions ---
        function formatCPF(value) {
            if (!value) return '';
            value = value.replace(/\D/g, '');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            return value;
        }

        function formatPhone(value) {
            if (!value) return '';
            value = value.replace(/\D/g, '');
            value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
            value = value.replace(/(\d)(\d{4})$/, '$1-$2');
            return value;
        }

        function formatDate(value) {
            if (!value) return '';
            value = value.replace(/\D/g, '');
            value = value.replace(/(\d{2})(\d)/, '$1/$2');
            value = value.replace(/(\d{2})(\d)/, '$1/$2');
            return value;
        }

        function calculateAge(dobString) {
            if (!dobString || dobString.length !== 10) return null;
            const parts = dobString.split('/');
            if (parts.length !== 3) return null;
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10);
            const year = parseInt(parts[2], 10);

            if (isNaN(day) || isNaN(month) || isNaN(year)) return null;

            const birthDate = new Date(year, month - 1, day);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        function showErrorMessage(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function hideErrorMessage() {
            errorMessage.textContent = '';
            errorMessage.style.display = 'none';
        }

        // --- Step Navigation ---
        function showStep(stepNum) {
            steps.forEach((step, index) => {
                step.classList.toggle('active', index + 1 === stepNum);
            });
            stepDots.forEach((dot, index) => {
                dot.classList.toggle('active', index + 1 === stepNum);
                dot.classList.toggle('completed', index + 1 < stepNum);
            });

            prevBtn.style.display = stepNum === 1 ? 'none' : 'inline-block';
            nextBtn.style.display = stepNum === steps.length ? 'none' : 'inline-block';
            submitBtn.style.display = stepNum === steps.length ? 'inline-block' : 'none';

            currentStep = stepNum;
            hideErrorMessage();

            // Update summary on step 5
            if (currentStep === 5) {
                updateSummary();
            }
        }

        function validateStep(stepNum) {
            hideErrorMessage();
            let isValid = true;

            switch (stepNum) {
                case 1:
                    const cpfInput = document.getElementById('cpf');
                    if (!cpfInput.value || cpfInput.value.replace(/\D/g, '').length !== 11) {
                        showErrorMessage('Por favor, insira um CPF válido com 11 dígitos.');
                        isValid = false;
                    }
                    formData.cpf = cpfInput.value;
                    break;
                case 2:
                    const parentName = document.getElementById('parentName').value;
                    const phone = document.getElementById('phone').value;
                    const parentEmail = document.getElementById('parentEmail').value;
                    const password = document.getElementById('password').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;

                    if (!parentName || !phone || !parentEmail || !password || !confirmPassword) {
                        showErrorMessage('Por favor, preencha todos os campos do responsável.');
                        isValid = false;
                    } else if (password.length < 6) {
                        showErrorMessage('A senha deve ter no mínimo 6 caracteres.');
                        isValid = false;
                    } else if (password !== confirmPassword) {
                        showErrorMessage('As senhas não coincidem.');
                        isValid = false;
                    }
                    formData.parentName = parentName;
                    formData.phone = phone;
                    formData.parentEmail = parentEmail;
                    formData.password = password;
                    formData.confirmPassword = confirmPassword;
                    break;
                case 3:
                    const childForms = childrenFormsContainer.querySelectorAll('.child-form');
                    if (childForms.length === 0) {
                        showErrorMessage('Por favor, adicione pelo menos um filho.');
                        isValid = false;
                        break;
                    }
                    formData.children = [];
                    childForms.forEach((form, index) => {
                        const nameInput = form.querySelector('.child-name');
                        const schoolInput = form.querySelector('.child-school');
                        const classInput = form.querySelector('.child-class');
                        const shiftInput = form.querySelector('.child-shift');
                        const dobInput = form.querySelector('.child-dob');
                        const photoInput = form.querySelector('.child-photo');

                        if (!nameInput.value || !dobInput.value || dobInput.value.replace(/\D/g, '').length !== 8) {
                            showErrorMessage(`Por favor, preencha o nome e a data de nascimento válida para o filho ${index + 1}.`);
                            isValid = false;
                        }
                        
                        formData.children.push({
                            name: nameInput.value,
                            school: schoolInput.value,
                            class: classInput.value,
                            shift: shiftInput.value,
                            dob: dobInput.value,
                            photoFile: photoInput.files[0] || null, // Store the File object
                            photoPreview: photoInput.dataset.previewUrl || null // Store the preview URL
                        });
                    });
                    break;
                case 4:
                    if (!formData.selectedPlan && formData.selectedProducts.length === 0) {
                        showErrorMessage('Por favor, selecione um plano ou pelo menos um produto avulso.');
                        isValid = false;
                    }
                    break;
            }
            return isValid;
        }

        nextBtn.addEventListener('click', () => {
            if (validateStep(currentStep)) {
                showStep(currentStep + 1);
            }
        });

        prevBtn.addEventListener('click', () => {
            showStep(currentStep - 1);
        });

        // --- Dynamic Child Forms ---
        function updateChildFormNumbers() {
            const childForms = childrenFormsContainer.querySelectorAll('.child-form');
            childForms.forEach((form, index) => {
                form.querySelector('.child-number').textContent = index + 1;
                const removeBtn = form.querySelector('.remove-child-btn');
                removeBtn.style.display = childForms.length > 1 ? 'inline-block' : 'none';
            });
        }

        function addInitialChildForm() {
            if (childrenFormsContainer.children.length === 0) {
                addChild();
            }
        }

        function addChild() {
            const clone = childFormTemplate.content.cloneNode(true);
            const childFormDiv = clone.querySelector('.child-form');
            const index = childrenFormsContainer.children.length;

            // Update IDs and names for uniqueness
            childFormDiv.querySelectorAll('input, select, label').forEach(el => {
                if (el.id) el.id = `${el.id}-${index}`;
                if (el.htmlFor) el.htmlFor = `${el.htmlFor}-${index}`;
                if (el.name) el.name = `${el.name}-${index}`;
            });

            // Set contract name as school
            const schoolInput = childFormDiv.querySelector('.child-school');
            if (schoolInput) {
                schoolInput.value = contractData.name;
            }

            // Add event listeners for new child form
            const removeBtn = childFormDiv.querySelector('.remove-child-btn');
            removeBtn.addEventListener('click', () => {
                childFormDiv.remove();
                updateChildFormNumbers();
            });

            const dobInput = childFormDiv.querySelector('.child-dob');
            dobInput.addEventListener('input', (e) => {
                e.target.value = formatDate(e.target.value);
                const age = calculateAge(e.target.value);
                const ageDisplay = childFormDiv.querySelector('.child-age-display');
                if (age !== null) {
                    ageDisplay.textContent = `Idade: ${age} anos`;
                } else {
                    ageDisplay.textContent = '';
                }
            });

            const photoInput = childFormDiv.querySelector('.child-photo');
            photoInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                const previewContainer = childFormDiv.querySelector('.photo-preview-container');
                const previewImg = childFormDiv.querySelector('.photo-preview');
                const filenameSpan = childFormDiv.querySelector('.photo-filename');

                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        previewImg.src = event.target.result;
                        photoInput.dataset.previewUrl = event.target.result; // Store preview URL
                        filenameSpan.textContent = file.name;
                        previewContainer.style.display = 'flex';
                    };
                    reader.readAsDataURL(file);
                } else {
                    previewContainer.style.display = 'none';
                    previewImg.src = '';
                    photoInput.dataset.previewUrl = '';
                    filenameSpan.textContent = '';
                }
            });

            childrenFormsContainer.appendChild(clone);
            updateChildFormNumbers();
        }

        addChildBtn.addEventListener('click', addChild);

        // --- Plan/Product Selection ---
        function renderPlansAndProducts() {
            plansContainer.innerHTML = '';
            productsContainer.innerHTML = '';
            noPlansProductsMessage.style.display = 'none';

            if (contractData.plans.length === 0 && contractData.products.length === 0) {
                noPlansProductsMessage.style.display = 'block';
                planSelectionMessage.textContent = '';
                return;
            }

            if (contractData.plans.length > 0) {
                planSelectionMessage.textContent = 'Escolha seu Plano (produtos avulsos serão desmarcados):';
                contractData.plans.forEach(plan => {
                    const div = document.createElement('div');
                    div.className = 'plan-option';
                    div.dataset.id = plan.id;
                    div.innerHTML = `
                        <input type="radio" name="selectedPlan" id="plan-${plan.id}" value="${plan.id}" ${formData.selectedPlan === plan.id ? 'checked' : ''}>
                        <label for="plan-${plan.id}">${plan.name}</label>
                        <span class="price">${formatCurrency(plan.price)}</span>
                        ${plan.description ? `<p class="description">${plan.description}</p>` : ''}
                    `;
                    div.addEventListener('click', () => {
                        document.getElementById(`plan-${plan.id}`).checked = true;
                        handlePlanSelection(plan.id);
                    });
                    plansContainer.appendChild(div);
                });
            }

            if (contractData.products.length > 0) {
                const productHeader = document.createElement('h3');
                productHeader.textContent = 'Ou Adicione Produtos Avulsos (o plano será desmarcado):';
                productsContainer.appendChild(productHeader);

                contractData.products.forEach(product => {
                    const div = document.createElement('div');
                    div.className = 'product-option';
                    div.dataset.id = product.id;
                    div.innerHTML = `
                        <input type="checkbox" name="selectedProducts" id="product-${product.id}" value="${product.id}" ${formData.selectedProducts.includes(product.id) ? 'checked' : ''}>
                        <label for="product-${product.id}">${product.name}</label>
                        <span class="price">${formatCurrency(product.price)}</span>
                        ${product.description ? `<p class="description">${product.description}</p>` : ''}
                    `;
                    div.addEventListener('click', () => {
                        const checkbox = document.getElementById(`product-${product.id}`);
                        checkbox.checked = !checkbox.checked;
                        handleProductSelection(product.id, checkbox.checked);
                    });
                    productsContainer.appendChild(div);
                });
            }
            updatePlanProductSelectionUI();
        }

        function handlePlanSelection(planId) {
            formData.selectedPlan = planId;
            formData.selectedProducts = []; // Clear products if a plan is selected
            updatePlanProductSelectionUI();
        }

        function handleProductSelection(productId, isChecked) {
            if (isChecked) {
                if (!formData.selectedProducts.includes(productId)) {
                    formData.selectedProducts.push(productId);
                }
                formData.selectedPlan = null; // Clear plan if products are selected
            } else {
                formData.selectedProducts = formData.selectedProducts.filter(id => id !== productId);
            }
            updatePlanProductSelectionUI();
        }

        function updatePlanProductSelectionUI() {
            document.querySelectorAll('.plan-option').forEach(div => {
                const input = div.querySelector('input[type="radio"]');
                if (input.value === formData.selectedPlan) {
                    div.classList.add('selected');
                    input.checked = true;
                } else {
                    div.classList.remove('selected');
                    input.checked = false;
                }
            });

            document.querySelectorAll('.product-option').forEach(div => {
                const input = div.querySelector('input[type="checkbox"]');
                if (formData.selectedProducts.includes(input.value)) {
                    div.classList.add('selected');
                    input.checked = true;
                } else {
                    div.classList.remove('selected');
                    input.checked = false;
                }
            });
        }

        // --- Summary Update ---
        function updateSummary() {
            summaryContainer.innerHTML = '';

            const items = [
                { label: 'CPF', value: formData.cpf },
                { label: 'Nome do Responsável', value: formData.parentName },
                { label: 'Telefone', value: formData.phone },
                { label: 'Email', value: formData.parentEmail },
            ];

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'summary-item';
                div.innerHTML = `<strong>${item.label}:</strong> ${item.value}`;
                summaryContainer.appendChild(div);
            });

            if (formData.children.length > 0) {
                const childrenDiv = document.createElement('div');
                childrenDiv.className = 'summary-item';
                childrenDiv.innerHTML = '<strong>Filho(s) Cadastrado(s):</strong>';
                const ul = document.createElement('ul');
                ul.style.marginLeft = '20px';
                formData.children.forEach(child => {
                    const li = document.createElement('li');
                    let childSummary = `${child.name} (Escola: ${child.school}, Turma: ${child.class || 'N/A'}, Turno: ${child.shift || 'N/A'}, Nasc: ${child.dob})`;
                    if (child.photoFile) {
                        childSummary += ' (Foto selecionada)';
                    }
                    li.textContent = childSummary;
                    ul.appendChild(li);
                });
                childrenDiv.appendChild(ul);
                summaryContainer.appendChild(childrenDiv);
            }

            if (formData.selectedPlan) {
                const plan = contractData.plans.find(p => p.id === formData.selectedPlan);
                const div = document.createElement('div');
                div.className = 'summary-item';
                div.innerHTML = `<strong>Plano Selecionado:</strong> ${plan ? plan.name : 'N/A'} (${plan ? formatCurrency(plan.price) : ''})`;
                summaryContainer.appendChild(div);
            } else if (formData.selectedProducts.length > 0) {
                const products = formData.selectedProducts.map(id => contractData.products.find(p => p.id === id)?.name).filter(Boolean);
                const div = document.createElement('div');
                div.className = 'summary-item';
                div.innerHTML = `<strong>Produtos Avulsos:</strong> ${products.join(', ')}`;
                summaryContainer.appendChild(div);
            }
        }

        // --- Form Submission ---
        document.getElementById('registrationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!validateStep(currentStep)) {
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Finalizando...';
            hideErrorMessage();

            try {
                // Simulate photo upload and get URLs
                const photoUploadPromises = formData.children.map(async (child, index) => {
                    if (child.photoFile) {
                        // In a real scenario, you'd upload to Supabase Storage here
                        // For this example, we'll just simulate a URL
                        const simulatedPhotoUrl = `https://your-supabase-bucket.com/child_profile_photos/${contractToken}_child_${index}_${Date.now()}_${child.photoFile.name}`;
                        child.photoPreview = simulatedPhotoUrl; // Update with actual URL after upload
                        // Simulate upload delay
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                });
                await Promise.all(photoUploadPromises);

                const payload = {
                    contractSlug: contractToken,
                    cpf: formData.cpf.replace(/\D/g, ''), // Remove mask for backend
                    parentName: formData.parentName,
                    phone: formData.phone.replace(/\D/g, ''), // Remove mask for backend
                    parentEmail: formData.parentEmail,
                    password: formData.password,
                    children: formData.children.map(child => ({
                        name: child.name,
                        school: child.school,
                        class: child.class,
                        shift: child.shift,
                        dob: child.dob,
                        photoPreview: child.photoPreview // Send the URL
                    })),
                    selectedPlan: formData.selectedPlan,
                    selectedProducts: formData.selectedProducts
                };

                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message);
                    window.location.href = '/client/dashboard'; // Redirect to client dashboard
                } else {
                    showErrorMessage(result.error || 'Erro desconhecido ao finalizar cadastro.');
                }
            } catch (error) {
                console.error('Erro ao enviar formulário:', error);
                showErrorMessage('Ocorreu um erro ao tentar finalizar o cadastro. Tente novamente.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Finalizar Cadastro';
            }
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Extract contractSlug from URL
            const pathParts = window.location.pathname.split('/');
            const slugIndex = pathParts.indexOf('cadastro') + 1;
            if (slugIndex > 0 && slugIndex < pathParts.length) {
                contractToken = pathParts[slugIndex];
            } else {
                showErrorMessage('Token de contrato não encontrado na URL.');
                return;
            }

            // Fetch contract data
            try {
                // This is a placeholder. You need to implement this endpoint in your Flask app.
                const response = await fetch(`/api/contract-details/${contractToken}`); 
                if (!response.ok) {
                    throw new Error('Contrato não encontrado ou inválido.');
                }
                const data = await response.json();
                contractData.id = data.id;
                contractData.name = data.name;
                contractData.plans = data.plans || [];
                contractData.products = data.products || [];
                contractNameDisplay.textContent = `Contrato: ${contractData.name}`;
                renderPlansAndProducts();
            } catch (error) {
                showErrorMessage(error.message || 'Erro ao carregar dados do contrato.');
                return;
            }

            showStep(1);
            addInitialChildForm(); // Add one child form by default
        });

        // --- Input Masking ---
        document.getElementById('cpf').addEventListener('input', (e) => {
            e.target.value = formatCPF(e.target.value);
        });
        document.getElementById('phone').addEventListener('input', (e) => {
            e.target.value = formatPhone(e.target.value);
        });

        // NEW: Script para desabilitar o botão de finalizar
        const form = document.getElementById('registrationForm');
        const botaoFinalizar = document.getElementById('submitBtn'); // Usar o ID correto do botão

        form.addEventListener('submit', function() {
            // Desabilita o botão para evitar cliques repetidos
            botaoFinalizar.disabled = true;
            // Muda o texto para dar um feedback visual
            botaoFinalizar.innerText = 'Processando...';
        });
    </script>
</body>
</html>